{% extends "base.html" %}

{% block title %}Gestión de Pedidos - DomiFlash{% endblock %}

{% block content %}
<div class="min-h-screen dark-bg p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header con título y estadísticas -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-3xl font-bold dark-text mb-2">📋 Gestión de Pedidos</h1>
          <p class="text-gray-600 dark:text-gray-400">Administra los pedidos de tu restaurante</p>
        </div>
        <div class="text-right">
          <div class="text-2xl font-bold text-domi-orange">{{ pedidos|length }}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Total Pedidos</div>
        </div>
      </div>

      <!-- Filtros rápidos -->
      <div class="flex flex-wrap gap-3 mb-6">
        <button class="filter-btn active" data-filter="all">
          📦 Todos
        </button>
        <button class="filter-btn" data-filter="pendiente">
          ⏳ Pendientes
        </button>
        <button class="filter-btn" data-filter="aceptado">
          ✅ Aceptados
        </button>
        <button class="filter-btn" data-filter="preparando">
          👨‍🍳 Preparando
        </button>
        <button class="filter-btn" data-filter="entregado">
          🚚 Entregados
        </button>
      </div>
    </div>

    <!-- Tabla de pedidos con estilo moderno -->
    <div class="dark-card overflow-hidden">
      {% if pedidos %}
        <div class="overflow-x-auto">
          <table class="table-auto w-full">
            <thead class="bg-gray-800 dark:bg-gray-900">
              <tr>
                <th class="px-6 py-4 text-left text-white font-semibold">ID</th>
                <th class="px-6 py-4 text-left text-white font-semibold">Cliente</th>
                <th class="px-6 py-4 text-left text-white font-semibold">Tipo de Entrega</th>
                <th class="px-6 py-4 text-left text-white font-semibold">Total</th>
                <th class="px-6 py-4 text-center text-white font-semibold">Estado</th>
                <th class="px-6 py-4 text-center text-white font-semibold">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pedido in pedidos %}
              <tr class="border-b dark-border hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors pedido-row" data-estado="{{ pedido.estped }}">
                <td class="px-6 py-4">
                  <div class="text-sm font-semibold dark-text">#{{ pedido.idped }}</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">{{ pedido.fecha_creacion.strftime('%d/%m/%Y %H:%M') if pedido.fecha_creacion else 'Sin fecha' }}</div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center">
                    <div class="w-10 h-10 bg-domi-orange bg-opacity-20 rounded-full flex items-center justify-center text-domi-orange font-bold mr-3">
                      {{ pedido.cliente[0].upper() if pedido.cliente else 'U' }}
                    </div>
                    <div>
                      <div class="text-sm font-medium dark-text">{{ pedido.cliente or 'Cliente' }}</div>
                      <div class="text-xs text-gray-500 dark:text-gray-400">Cliente registrado</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm dark-text">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                      📍 Entrega a domicilio
                    </span>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="text-lg font-bold text-green-600 dark:text-green-400">${{ "{:,.0f}".format(pedido.total) }}</div>
                </td>
                <td class="px-6 py-4 text-center">
                  <span class="estado-badge estado-{{ pedido.estped }}">
                    {% if pedido.estped == 'pendiente' %}⏳ Pendiente
                    {% elif pedido.estped == 'aceptado' %}✅ Aceptado
                    {% elif pedido.estped == 'preparando' %}👨‍🍳 Preparando
                    {% elif pedido.estped == 'en_camino' %}🚚 En Camino
                    {% elif pedido.estped == 'entregado' %}✅ Entregado
                    {% elif pedido.estped == 'cancelado' %}❌ Cancelado
                    {% else %}{{ pedido.estped }}
                    {% endif %}
                  </span>
                </td>
                <td class="px-6 py-4 text-center">
                  <div class="flex justify-center space-x-2">
                    <a href="/restaurante/pedidos/{{ pedido.idped }}" 
                       class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                      👁️ Ver
                    </a>
                    {% if pedido.estped in ['pendiente', 'aceptado', 'preparando'] %}
                    <button onclick="cambiarEstado({{ pedido.idped }}, '{{ pedido.estped }}')"
                            class="bg-domi-orange hover:bg-orange-600 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                      📝 Estado
                    </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-12">
          <div class="text-6xl mb-4">📋</div>
          <h3 class="text-xl font-semibold dark-text mb-2">No hay pedidos aún</h3>
          <p class="text-gray-600 dark:text-gray-400">Los pedidos de tu restaurante aparecerán aquí</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
.filter-btn {
  @apply px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200;
  @apply bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300;
  @apply hover:bg-gray-300 dark:hover:bg-gray-600;
}

.filter-btn.active {
  @apply bg-domi-orange text-white shadow-lg;
}

.estado-badge {
  @apply px-3 py-1 rounded-full text-xs font-semibold;
}

.estado-pendiente {
  @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200;
}

.estado-aceptado {
  @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200;
}

.estado-preparando {
  @apply bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200;
}

.estado-en_camino {
  @apply bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200;
}

.estado-entregado {
  @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200;
}

.estado-cancelado {
  @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;
}
</style>

<script>
// Filtros de pedidos
document.addEventListener('DOMContentLoaded', function() {
  const filterBtns = document.querySelectorAll('.filter-btn');
  const pedidoRows = document.querySelectorAll('.pedido-row');

  filterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // Actualizar botón activo
      filterBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      // Filtrar filas
      const filter = this.dataset.filter;
      pedidoRows.forEach(row => {
        if (filter === 'all' || row.dataset.estado === filter) {
          row.style.display = 'table-row';
        } else {
          row.style.display = 'none';
        }
      });
    });
  });
});

// Función para cambiar estado de pedido
function cambiarEstado(pedidoId, estadoActual) {
  const estados = {
    'pendiente': 'aceptado',
    'aceptado': 'preparando', 
    'preparando': 'en_camino'
  };
  
  const nuevoEstado = estados[estadoActual];
  if (!nuevoEstado) return;
  
  if (confirm(`¿Cambiar estado a "${nuevoEstado}"?`)) {
    // Aquí podrías hacer una petición AJAX para cambiar el estado
    fetch(`/restaurante/pedidos/${pedidoId}/estado`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({estado: nuevoEstado})
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    })
    .catch(error => {
      alert('Error al cambiar el estado');
    });
  }
}
</script>
{% endblock %}
